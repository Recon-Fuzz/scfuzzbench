name: Benchmark Run

on:
  workflow_dispatch:
    inputs:
      target_repo_url:
        description: "Target repository URL."
        required: true
      target_commit:
        description: "Target repository commit hash."
        required: true
      benchmark_type:
        description: "Benchmark type."
        required: true
        type: choice
        options:
          - property
          - optimization
        default: property
      instance_type:
        description: "EC2 instance type."
        required: true
        default: c6a.8xlarge
      instances_per_fuzzer:
        description: "Number of instances per fuzzer."
        required: true
        type: number
        default: 10
      timeout_hours:
        description: "Timeout per fuzzer run (hours)."
        required: true
        type: number
        default: 24
      disabled_fuzzers_json:
        description: "JSON list of fuzzer keys to disable (optional)."
        required: false
        default: '["echidna-symexec"]'
      foundry_version:
        description: "Override Foundry version (optional)."
        required: false
        default: ""
      foundry_git_repo:
        description: "Optional Foundry git repo (build from source)."
        required: false
        default: ""
      foundry_git_ref:
        description: "Optional Foundry git ref (branch/tag/commit)."
        required: false
        default: ""
      echidna_version:
        description: "Override Echidna version (optional)."
        required: false
        default: ""
      medusa_version:
        description: "Override Medusa version (optional)."
        required: false
        default: ""
      bitwuzla_version:
        description: "Override Bitwuzla version (optional)."
        required: false
        default: ""
      git_token_ssm_parameter_name:
        description: "SSM parameter name for Git token (optional)."
        required: false
        default: ""
      properties_path:
        description: "Repo-relative properties path for benchmark mode switching (optional)."
        required: false
        default: ""
      fuzzer_env_json:
        description: "JSON map of extra fuzzer env vars (optional)."
        required: false
        default: ""
  workflow_call:
    inputs:
      target_repo_url:
        description: "Target repository URL."
        required: true
        type: string
      target_commit:
        description: "Target repository commit hash."
        required: true
        type: string
      benchmark_type:
        description: "Benchmark type."
        required: false
        type: string
        default: property
      instance_type:
        description: "EC2 instance type."
        required: false
        type: string
        default: c6a.8xlarge
      instances_per_fuzzer:
        description: "Number of instances per fuzzer."
        required: false
        type: number
        default: 10
      timeout_hours:
        description: "Timeout per fuzzer run (hours)."
        required: false
        type: number
        default: 24
      disabled_fuzzers_json:
        description: "JSON list of fuzzer keys to disable (optional)."
        required: false
        type: string
        default: '["echidna-symexec"]'
      foundry_version:
        description: "Override Foundry version (optional)."
        required: false
        type: string
        default: ""
      foundry_git_repo:
        description: "Optional Foundry git repo (build from source)."
        required: false
        type: string
        default: ""
      foundry_git_ref:
        description: "Optional Foundry git ref (branch/tag/commit)."
        required: false
        type: string
        default: ""
      echidna_version:
        description: "Override Echidna version (optional)."
        required: false
        type: string
        default: ""
      medusa_version:
        description: "Override Medusa version (optional)."
        required: false
        type: string
        default: ""
      bitwuzla_version:
        description: "Override Bitwuzla version (optional)."
        required: false
        type: string
        default: ""
      git_token_ssm_parameter_name:
        description: "SSM parameter name for Git token (optional)."
        required: false
        type: string
        default: ""
      properties_path:
        description: "Repo-relative properties path for benchmark mode switching (optional)."
        required: false
        type: string
        default: ""
      fuzzer_env_json:
        description: "JSON map of extra fuzzer env vars (optional)."
        required: false
        type: string
        default: ""
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      SCFUZZBENCH_BUCKET:
        required: true
      TF_BACKEND_CONFIG:
        required: true
      AWS_REGION:
        required: false
    outputs:
      bucket_name:
        description: "S3 bucket used for run artifacts."
        value: ${{ jobs.benchmark-run.outputs.bucket_name }}
      run_id:
        description: "Run ID (Unix timestamp)."
        value: ${{ jobs.benchmark-run.outputs.run_id }}
      benchmark_uuid:
        description: "Benchmark UUID (derived from manifest)."
        value: ${{ jobs.benchmark-run.outputs.benchmark_uuid }}

permissions:
  contents: read

jobs:
  benchmark-run:
    runs-on: ubuntu-latest
    outputs:
      bucket_name: ${{ steps.tf_outputs.outputs.bucket_name }}
      run_id: ${{ steps.tf_outputs.outputs.run_id }}
      benchmark_uuid: ${{ steps.tf_outputs.outputs.benchmark_uuid }}
    env:
      AWS_REGION: ${{ secrets.AWS_REGION != '' && secrets.AWS_REGION || 'us-east-1' }}
      SCFUZZBENCH_BUCKET: ${{ secrets.SCFUZZBENCH_BUCKET }}
    steps:
      - name: Checkout (tarball)
        timeout-minutes: 5
        env:
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          url="https://codeload.github.com/${REPO}/tar.gz/${SHA}"
          curl -fsSL "${url}" -o repo.tar.gz
          topdir="$(tar -tzf repo.tar.gz | sed -n '1p' | cut -d/ -f1)"
          tar -xzf repo.tar.gz
          shopt -s dotglob
          mv "${topdir}"/* .
          rm -rf "${topdir}" repo.tar.gz

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Ensure AWS credentials are configured
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "Set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets." >&2
            exit 1
          fi
          if [ -z "${AWS_REGION}" ]; then
            echo "Set AWS_REGION secret." >&2
            exit 1
          fi
          if [ -z "${SCFUZZBENCH_BUCKET}" ]; then
            echo "Set SCFUZZBENCH_BUCKET secret." >&2
            exit 1
          fi

      - name: Configure AWS credentials (keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Write backend config from secret
        env:
          TF_BACKEND_CONFIG: ${{ secrets.TF_BACKEND_CONFIG }}
        run: |
          set -euo pipefail
          if [ -n "${TF_BACKEND_CONFIG}" ]; then
            printf '%s' "${TF_BACKEND_CONFIG}" > infrastructure/backend.hcl
          fi

      - name: Ensure backend config exists
        run: |
          if [ ! -f infrastructure/backend.hcl ]; then
            echo "Missing infrastructure/backend.hcl. Create it or set TF_BACKEND_CONFIG secret." >&2
            exit 1
          fi

      - name: Terraform init (remote backend)
        run: make terraform-init-backend BACKEND_CONFIG=backend.hcl

      - name: Validate inputs
        env:
          TARGET_REPO_URL: ${{ inputs.target_repo_url }}
          TARGET_COMMIT: ${{ inputs.target_commit }}
          BENCHMARK_TYPE: ${{ inputs.benchmark_type }}
          INSTANCE_TYPE: ${{ inputs.instance_type }}
          INSTANCES_PER_FUZZER: ${{ inputs.instances_per_fuzzer }}
          TIMEOUT_HOURS: ${{ inputs.timeout_hours }}
          DISABLED_FUZZERS_JSON: ${{ inputs.disabled_fuzzers_json }}
          FOUNDRY_VERSION: ${{ inputs.foundry_version }}
          FOUNDRY_GIT_REPO: ${{ inputs.foundry_git_repo }}
          FOUNDRY_GIT_REF: ${{ inputs.foundry_git_ref }}
          ECHIDNA_VERSION: ${{ inputs.echidna_version }}
          MEDUSA_VERSION: ${{ inputs.medusa_version }}
          BITWUZLA_VERSION: ${{ inputs.bitwuzla_version }}
          GIT_TOKEN_SSM_PARAMETER_NAME: ${{ inputs.git_token_ssm_parameter_name }}
          PROPERTIES_PATH: ${{ inputs.properties_path }}
          FUZZER_ENV_JSON: ${{ inputs.fuzzer_env_json }}
        run: |
          set -euo pipefail

          fail() {
            echo "Invalid input: $1" >&2
            exit 1
          }

          is_single_line() {
            [[ "$1" != *$'\n'* && "$1" != *$'\r'* ]]
          }

          # These values are interpolated into Terraform args and later into user-data.
          # Keep them conservative to avoid shell-quoting surprises.
          has_forbidden_chars() {
            local s="$1"
            [[ "$s" == *'"'* || "$s" == *'`'* || "$s" == *'$'* || "$s" == *'\\'* ]]
          }

          require_safe() {
            local name="$1"
            local value="$2"
            if ! is_single_line "$value"; then
              fail "${name} must be a single line"
            fi
            if has_forbidden_chars "$value"; then
              fail "${name} contains a forbidden character (\", \\\\, $, `)"
            fi
          }

          require_safe "target_repo_url" "${TARGET_REPO_URL}"
          require_safe "target_commit" "${TARGET_COMMIT}"
          require_safe "benchmark_type" "${BENCHMARK_TYPE}"
          require_safe "instance_type" "${INSTANCE_TYPE}"

          if [[ -n "${FOUNDRY_VERSION}" ]]; then
            require_safe "foundry_version" "${FOUNDRY_VERSION}"
            if [[ ! "${FOUNDRY_VERSION}" =~ ^[A-Za-z0-9._+-]+$ ]]; then
              fail "foundry_version must not contain spaces"
            fi
          fi

          if [[ -n "${FOUNDRY_GIT_REPO}" ]]; then
            require_safe "foundry_git_repo" "${FOUNDRY_GIT_REPO}"
            if [[ ! "${FOUNDRY_GIT_REPO}" =~ ^https://github\\.com/[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+(\\.git)?/?$ ]]; then
              fail "foundry_git_repo must be https://github.com/<org>/<repo>"
            fi
          fi

          if [[ -n "${FOUNDRY_GIT_REF}" ]]; then
            require_safe "foundry_git_ref" "${FOUNDRY_GIT_REF}"
            if [[ ! "${FOUNDRY_GIT_REF}" =~ ^[A-Za-z0-9._/-]+$ ]]; then
              fail "foundry_git_ref must not contain spaces"
            fi
          fi

          if [[ -n "${ECHIDNA_VERSION}" ]]; then
            require_safe "echidna_version" "${ECHIDNA_VERSION}"
          fi
          if [[ -n "${MEDUSA_VERSION}" ]]; then
            require_safe "medusa_version" "${MEDUSA_VERSION}"
          fi
          if [[ -n "${BITWUZLA_VERSION}" ]]; then
            require_safe "bitwuzla_version" "${BITWUZLA_VERSION}"
          fi

          if [[ ! "${TARGET_REPO_URL}" =~ ^https://github\\.com/[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+(\\.git)?/?$ ]]; then
            fail "target_repo_url must be https://github.com/<org>/<repo>"
          fi

          if [[ ! "${TARGET_COMMIT}" =~ ^[A-Za-z0-9][A-Za-z0-9._/-]{0,199}$ ]]; then
            fail "target_commit must be a commit SHA, tag, or branch (no spaces)"
          fi

          case "${BENCHMARK_TYPE}" in
            property|optimization) ;;
            *) fail "benchmark_type must be property or optimization" ;;
          esac

          if [[ ! "${INSTANCE_TYPE}" =~ ^[a-z0-9]+\\.[a-z0-9]+$ ]]; then
            fail "instance_type must look like c6a.4xlarge"
          fi

          if [[ ! "${INSTANCES_PER_FUZZER}" =~ ^[0-9]+$ ]] || (( INSTANCES_PER_FUZZER < 1 )) || (( INSTANCES_PER_FUZZER > 20 )); then
            fail "instances_per_fuzzer must be an integer in [1, 20]"
          fi

          if [[ ! "${TIMEOUT_HOURS}" =~ ^[0-9]+(\\.[0-9]+)?$ ]]; then
            fail "timeout_hours must be a number"
          fi
          python3 - <<'PY'
          import os
          hours = float(os.environ["TIMEOUT_HOURS"])
          if hours < 0.25 or hours > 72:
              raise SystemExit("timeout_hours must be in [0.25, 72]")
          PY

          python3 - <<'PY'
          import json
          import os
          import re

          raw = os.environ.get("DISABLED_FUZZERS_JSON", "").strip()
          if not raw:
              raw = "[]"
          try:
              obj = json.loads(raw)
          except Exception as e:
              raise SystemExit(f"disabled_fuzzers_json must be valid JSON: {e}")
          if not isinstance(obj, list):
              raise SystemExit("disabled_fuzzers_json must be a JSON list")
          if len(obj) > 20:
              raise SystemExit("disabled_fuzzers_json has too many entries (max 20)")
          key_re = re.compile(r"^[a-z0-9][a-z0-9-]{0,63}$")
          for v in obj:
              if not isinstance(v, str) or not key_re.match(v):
                  raise SystemExit(f"Invalid disabled fuzzer key: {v!r}")
          PY

          if [[ -n "${GIT_TOKEN_SSM_PARAMETER_NAME}" ]]; then
            require_safe "git_token_ssm_parameter_name" "${GIT_TOKEN_SSM_PARAMETER_NAME}"
            if [[ ! "${GIT_TOKEN_SSM_PARAMETER_NAME}" =~ ^/scfuzzbench/[A-Za-z0-9_./-]+$ ]]; then
              fail "git_token_ssm_parameter_name must start with /scfuzzbench/"
            fi
          fi

          if [[ -n "${PROPERTIES_PATH}" ]]; then
            require_safe "properties_path" "${PROPERTIES_PATH}"
            if [[ "${PROPERTIES_PATH}" == /* || "${PROPERTIES_PATH}" == *".."* ]]; then
              fail "properties_path must be repo-relative and must not contain '..'"
            fi
            if [[ ! "${PROPERTIES_PATH}" =~ ^[A-Za-z0-9_./-]+$ ]]; then
              fail "properties_path must not contain spaces"
            fi
          fi

          if [[ -n "${FUZZER_ENV_JSON}" ]]; then
            python3 - <<'PY'
          import json
          import os
          import re
          raw = os.environ["FUZZER_ENV_JSON"]
          try:
              obj = json.loads(raw)
          except Exception as e:
              raise SystemExit(f"Invalid fuzzer_env_json: {e}")
          if not isinstance(obj, dict):
              raise SystemExit("fuzzer_env_json must be a JSON object")
          if len(obj) > 64:
              raise SystemExit("fuzzer_env_json has too many keys (max 64)")
          key_re = re.compile(r"^[A-Z][A-Z0-9_]{0,63}$")
          forbidden = re.compile(r'[\r\n"`$\\\\]')
          for k, v in obj.items():
              if not isinstance(k, str) or not key_re.match(k):
                  raise SystemExit(f"Invalid env key: {k}")
              if not isinstance(v, str):
                  raise SystemExit(f"Env value for {k} must be a string")
              if len(v) > 2000:
                  raise SystemExit(f"Env value for {k} too long (max 2000 chars)")
              if forbidden.search(v):
                  raise SystemExit(f"Env value for {k} contains a forbidden character")
          PY
          fi

      - name: Terraform apply
        id: apply
        env:
          TARGET_REPO_URL: ${{ inputs.target_repo_url }}
          TARGET_COMMIT: ${{ inputs.target_commit }}
          BENCHMARK_TYPE: ${{ inputs.benchmark_type }}
          INSTANCE_TYPE: ${{ inputs.instance_type }}
          INSTANCES_PER_FUZZER: ${{ inputs.instances_per_fuzzer }}
          TIMEOUT_HOURS: ${{ inputs.timeout_hours }}
          DISABLED_FUZZERS_JSON: ${{ inputs.disabled_fuzzers_json }}
          FOUNDRY_VERSION: ${{ inputs.foundry_version }}
          FOUNDRY_GIT_REPO: ${{ inputs.foundry_git_repo }}
          FOUNDRY_GIT_REF: ${{ inputs.foundry_git_ref }}
          ECHIDNA_VERSION: ${{ inputs.echidna_version }}
          MEDUSA_VERSION: ${{ inputs.medusa_version }}
          BITWUZLA_VERSION: ${{ inputs.bitwuzla_version }}
          GIT_TOKEN_SSM_PARAMETER_NAME: ${{ inputs.git_token_ssm_parameter_name }}
          FUZZER_ENV_JSON: ${{ inputs.fuzzer_env_json }}
          PROPERTIES_PATH: ${{ inputs.properties_path }}
        run: |
          set -euo pipefail
          run_id=$(date +%s)
          disabled_fuzzers="${DISABLED_FUZZERS_JSON:-}"
          if [[ -z "${disabled_fuzzers}" ]]; then
            disabled_fuzzers="[]"
          fi
          tf_args=(
            -var "aws_region=${AWS_REGION}"
            -var "existing_bucket_name=${SCFUZZBENCH_BUCKET}"
            -var "target_repo_url=${TARGET_REPO_URL}"
            -var "target_commit=${TARGET_COMMIT}"
            -var "benchmark_type=${BENCHMARK_TYPE}"
            -var "instance_type=${INSTANCE_TYPE}"
            -var "instances_per_fuzzer=${INSTANCES_PER_FUZZER}"
            -var "timeout_hours=${TIMEOUT_HOURS}"
            -var "disabled_fuzzers=${disabled_fuzzers}"
            -var "run_id=${run_id}"
            -var "scfuzzbench_commit=${GITHUB_SHA}"
          )

          if [[ -n "${FOUNDRY_VERSION}" ]]; then
            tf_args+=(-var "foundry_version=${FOUNDRY_VERSION}")
          fi
          if [[ -n "${FOUNDRY_GIT_REPO}" ]]; then
            tf_args+=(-var "foundry_git_repo=${FOUNDRY_GIT_REPO}")
          fi
          if [[ -n "${FOUNDRY_GIT_REF}" ]]; then
            tf_args+=(-var "foundry_git_ref=${FOUNDRY_GIT_REF}")
          fi
          if [[ -n "${ECHIDNA_VERSION}" ]]; then
            tf_args+=(-var "echidna_version=${ECHIDNA_VERSION}")
          fi
          if [[ -n "${MEDUSA_VERSION}" ]]; then
            tf_args+=(-var "medusa_version=${MEDUSA_VERSION}")
          fi
          if [[ -n "${BITWUZLA_VERSION}" ]]; then
            tf_args+=(-var "bitwuzla_version=${BITWUZLA_VERSION}")
          fi
          if [[ -n "${GIT_TOKEN_SSM_PARAMETER_NAME}" ]]; then
            tf_args+=(-var "git_token_ssm_parameter_name=${GIT_TOKEN_SSM_PARAMETER_NAME}")
          fi

          if [[ -n "${FUZZER_ENV_JSON}" || -n "${PROPERTIES_PATH}" ]]; then
            merged=$(python3 - <<'PY'
          import json
          import os

          data = {}
          raw = os.environ.get("FUZZER_ENV_JSON", "").strip()
          if raw:
              data.update(json.loads(raw))
          prop = os.environ.get("PROPERTIES_PATH", "").strip()
          if prop:
              data["SCFUZZBENCH_PROPERTIES_PATH"] = prop
          print(json.dumps(data))
          PY
            )
            tf_args+=(-var "fuzzer_env=${merged}")
          fi

          terraform -chdir=infrastructure apply -auto-approve "${tf_args[@]}"
          echo "run_id=${run_id}" >> "${GITHUB_OUTPUT}"

      - name: Collect Terraform outputs
        id: tf_outputs
        run: |
          terraform -chdir=infrastructure output -json > run_metadata.json
          bucket=$(jq -r '.bucket_name.value' run_metadata.json)
          run_id=$(jq -r '.run_id.value' run_metadata.json)
          benchmark_uuid=$(jq -r '.benchmark_uuid.value' run_metadata.json)
          {
            echo "bucket_name=${bucket}"
            echo "run_id=${run_id}"
            echo "benchmark_uuid=${benchmark_uuid}"
          } >> "${GITHUB_OUTPUT}"

      - name: Upload run metadata
        uses: actions/upload-artifact@v4
        with:
          name: run-metadata
          path: run_metadata.json

      - name: Summary
        run: |
          {
            echo "Benchmark run started."
            echo ""
            echo "- Bucket: ${{ steps.tf_outputs.outputs.bucket_name }}"
            echo "- Run ID: ${{ steps.tf_outputs.outputs.run_id }}"
            echo "- Benchmark UUID: ${{ steps.tf_outputs.outputs.benchmark_uuid }}"
          } >> "${GITHUB_STEP_SUMMARY}"
